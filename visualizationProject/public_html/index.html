<html>
<head>
  <meta charset="utf-8"/>
  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script src="http://visjs.org/dist/vis.js"></script>
  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" type="text/css" />
  <link rel="stylesheet" href="http://visjs.org/dist/vis.css" type="text/css" />
  <style type="text/css">
    #mynetwork {
        width: 49%;
        height: 650px;
        border: 1px solid lightgray;
        float: left;
    }
    #extraInfoContainer {
        width: 49%;
        height: 650px;
        border: 1px solid lightgray;
        display: block;
        overflow-x: auto;
    }
    #filterContainer {
        width: 98%;
    }
    #metricsTable {
        height: 100%;
        display: block;
        overflow-x: auto;
    }
    #edgeTable {
        height: auto;
        display: block;
        overflow-x: auto;
    }
    #fileSelectDialog {
        padding: 0;
        padding-top: 5px;
    }
    #setOrgTable {
        table-layout: fixed;
        height: auto;
        width: 100%;
        padding: 0;
    }
    #setOrgTable thead tr th:last-child, #setOrgTable tbody tr td:last-child {
        width: 50px;
    }
    #setOrgTable tbody tr td:last-child { /*Not the greatest selector - should be for all checkbox td's*/
        text-align: center;
    }
    #setOrgTable input {
        width: 100%;
    }
    #setOrgTable input[type="checkbox"] {
        width: initial;
    }
    #setOrgTable tbody td {
        word-wrap: break-word;
    }
    #jiraUrlDialog div>input {
        display: block;
    }
    #jiraUrlDialog input.ui-button {
        margin-top: 5px;
    }
    #navBar {
        width: 98%;
        list-style-type: none;
        margin: 0;
        padding: 0;
        overflow: hidden;
        border: 1px solid #e7e7e7;
        background-color: #f3f3f3;
    }
    #navBar li {
        display: inline;
        color: #666;
        text-align: center;
        padding: 14px 16px;
        text-decoration: none;
        border-right: 2px;
    }
    #navBar li:hover {
        background-color: #ddd;
        cursor: pointer;
    }
    #sourceTypeSelection input {
        display: block;
        position: relative;
        margin: 5 auto;
    }
    #prevDataSetSelect table tbody td {
        text-align: center;
        padding-bottom: 8px;
    }
    #prevDataSetSelect table tbody input {
        width: 79px;
    }
    #errorHeader {
        color: red;
    }
    .issueTypeFilter {
        margin: 10px;
        margin-left: 0;
    }
    .timeFilter {
        display: inline-block;
    }
    .filterHeader {
        margin-top: 10px;
        margin-bottom: 0;
    }
    .loader {
        border: 5px solid #f3f3f3; /* Light grey */
        border-top: 5px solid #3498db; /* Blue */
        border-radius: 50%;
        width: 15px;
        height: 15px;
        animation: spin 2s linear infinite;
        display: inline-block;
        margin-bottom: -10px;
    }
    .loader.center {
        position: relative;
        margin: auto;
        margin-top: 10px;
        display: block;
    }
    .loader.large {
        width: 100px;
        height: 100px;
        border: 33px solid #f3f3f3;
        border-top: 33px solid #3498db;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    h1 {
        text-align: center;
    }
  </style>
  <title>Network Visualization</title>
</head>
<body>
<ul id="navBar">
    <li id="newJiraSource">Select New JIRA Source</li>
    <li id="editUserOrgs">Edit User Organizations</li>
</ul>
<p>Current Data File: <span id="dataName"></span></p>
<div id="mynetwork"></div>
<div id="extraInfoContainer">
    <h1 style="display:none;"></h1>
    <div id="errorHeader" style="display:none;">
        <h2>Error - Unable to calculate metrics, likely due to insufficient data available for one or more organizations</h2>
        <h3>Try loosening the filters</h3>
    </div>
    <table id="metricsTable"></table>
    <table id="edgeTable"></table>
</div>
<div id="filterContainer">
    <h2 class="filterHeader">Time Filter: </h2>
    <fieldset class="timeFilter">
        <legend>Issue Creation Dates: </legend>
        <label for="creationFrom" title="Inclusive">From: </label>
        <input type="text" id="creationFrom" name="from">
        <label for="creationTo" title="Exclusive">To: </label>
        <input type="text" id="creationTo" name="to">
    </fieldset>
    <fieldset class="timeFilter">
        <legend>Issue Resolved Dates: </legend>
        <label for="resolutionFrom" title="Inclusive">From: </label>
        <input type="text" id="resolutionFrom" name="from">
        <label for="resolutionTo" title="Exclusive">To: </label>
        <input type="text" id="resolutionTo" name="to">
        <label for="notResolved">Not Resolved</label>
        <input type="checkbox" name="notResolved" id="notResolved" class="checkboxradio">
    </fieldset>
    <h2 class="filterHeader">Issue Type Filter: </h2>
    <fieldset id="issueTypeFieldset">
      <legend>Select Issue Types: </legend>
    </fieldset>
    <h2 class="filterHeader">Priority Filter: </h2>
    <fieldset id="prioritiesFieldset">
      <legend>Select Priorities: </legend>
    </fieldset>
</div>

<div id="sourceTypeSelection" class="dialog" title="Source Type Selection">
    <input id="newDataScrape" class="ui-button ui-widget ui-corner-all" value="New Data Scrape">
    <input id="loadPrevData" class="ui-button ui-widget ui-corner-all" value="Previously Scraped Data">
</div>

<div id="jiraUrlDialog" class="dialog" style="display:none;" title="JIRA URL">
  <form>
    <div>
    <label for="jiraUrlEntry">Enter a JIRA URL:</label>
    <input name="jiraUrl" id="jiraUrlEntry"/>
    </div>
    <div>
    <label for="jiraProjectEntry">Enter a Project:</label>
    <input name="jiraPoject" id="jiraProjectEntry"/>
    </div>
    <div>
    <label for="jiraFromDateEntry">Enter a From Date (based on issue updated date):</label>
    <input type="text" id="jiraFromDateEntry" name="jiraFromDate">
    </div>
    <input class="ui-button ui-widget ui-corner-all" type="submit" value="Submit"> <div class="loader" style="display:none;"></div>
  </form>
</div>

<div id="prevDataSetSelect" class="dialog" style="display:none;" title="Select a DataSet to Load">
    <table>
        <thead>
            <tr>
                <th>
                    
                </th>
                <th>
                    Data Creation Date (UTC)
                </th>
                <th>
                    API URL
                </th>
                <th>
                    Project
                </th>
                <th>
                    Scrape Date
                </th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

<div id='setOrganizations' class="dialog" style="display:none;" title="Set Organizations">
    <form>
        <table id="setOrgTable">
            <thead>
                <tr>
                    <th>
                        Username
                    </th>
                    <th>
                        Display Name
                    </th>
                    <th>
                        Email Address
                    </th>
                    <th>
                        Organization
                    </th>
                    <th>
                        Ignore
                    </th>
                </tr>
            </thead>
            <tbody>
                
            </tbody>
        </table>
        <input class="ui-button ui-widget ui-corner-all" type="submit" value="Submit"> <div class="loader" style="display:none;"></div>
    </form>
</div>
<script type="text/javascript">
    var desiredMetricColumns;
    var desiredEdgeColumns;
    var tableIdColumn;
    var gephiImported;
    var container = document.getElementById('mynetwork');
    var nodes = new vis.DataSet();
    var edges = new vis.DataSet();
    var data = { nodes: nodes, edges: edges };
    var options;
    var network;
    var doubleClickTime = 0;
    var threshold = 200;
    var dateFormat = "yy-mm-dd";
    var fileName;
    
    initialize();
    
    function initialize() {
        desiredMetricColumns = ["company", "closeness", "eigenvector", "degree", "betweenness"]; //Only display these columns in the table
        desiredEdgeColumns = ["author", "issueId", "issueComments", "numOfComments"];
        tableIdColumn = desiredMetricColumns[0]; //Make "company" the first column
        
        $("#navBar #editUserOrgs").on("click", editUserOrgsModal);
        $("#navBar #newJiraSource").on("click", selectJiraSourceModal);

        selectJiraSourceModal();
        
        $( "#sourceTypeSelection #newDataScrape").click(function(event, ui) {
            $( "#sourceTypeSelection" ).dialog("close");
            
            $( "#jiraUrlDialog>form" )
                .on("submit", function(event, ui) {
                    event.preventDefault();
            
                    $("#jiraUrlDialog .loader").css("display", "");
            
                    var url = $( "#jiraUrlEntry" ).val();
                    var project = $( "#jiraProjectEntry" ).val();
                    var fromDate = $( "#jiraFromDateEntry" ).val();
                    
                    //Send Sir Perceval on a quest
                    $.get("http://localhost:8080/quest/" + encodeURIComponent(url) + "?project=" + encodeURIComponent(project) + "&fromDate=" + encodeURIComponent(fromDate), function(data, status, jqXHR) {
                        setupApp(data);
			var splitInfo = parseDecodedQuery(decodeURIComponent(data))
                        $("#dataName").text(splitInfo["project"] + " scraped from " + splitInfo["url"] + " on " + splitInfo["created"] + " from " + splitInfo["from"]);
                        $("#jiraUrlDialog .loader").css("display", "none");
                        $(event.currentTarget).parents(".dialog").dialog("close");
                    });
            });
            
            $( "#jiraUrlDialog.dialog" ).dialog({
                modal: true
            });
        });
        
        $( "#sourceTypeSelection #loadPrevData").click(function(event, ui) {
            $( "#sourceTypeSelection" ).dialog("close");
            
            populateDataSetSelectModal();
        });
        
        setupEventHandlers();

        $( "#jiraFromDateEntry" ).datepicker({changeMonth: true,
                                        changeYear: true});
                                    
        $("input.checkboxradio").checkboxradio();
        $("#notResolved").checkboxradio("widget").css("height", "20px").css("padding-top", "0").css("padding-bottom", "0");

        $("#edgeTable").css("display","none");
    }
    
    function populateDataSetSelectModal() {
        $( "#prevDataSetSelect table tbody tr" ).remove();
        
        $.get("http://localhost:8080/storedData", function(data, status, jqXHR) {
            data.files.sort();

            for (file in data.files) {
                var splitInfo = parseDecodedQuery(decodeURIComponent(data.files[file]));
                $( "#prevDataSetSelect table tbody" ).append("<tr><td><input class=\"ui-button ui-widget ui-corner-all\"  value=\"Delete\" onClick=\"deleteFile('" + data.files[file] + "');\"></td><td>" + splitInfo["created"] + "</td><td>" + splitInfo["url"] + "</td><td>" + splitInfo["project"] + "</td><td>" + splitInfo["from"] + "</td><td><input class=\"ui-button ui-widget ui-corner-all\"  value=\"Select\" onClick=\"loadFile('" + data.files[file] + "');\"></td></tr>");
            }

            $( "#prevDataSetSelect.dialog" ).dialog({
                modal: true,
                width: "700px"
            });
        });
    }
    
    //Delete previously scraped data file
    function deleteFile(file) {
        $.ajax("http://localhost:8080/deleteData", {data: file, type: "POST", complete: function() {
                $( "#prevDataSetSelect" ).dialog("close");
                
                populateDataSetSelectModal();
                
                $( "#prevDataSetSelect" ).dialog("open");
            }
        });
    }
    
    //Load previously scraped data from the given file
    function loadFile(file) {
        $.ajax("http://localhost:8080/load", {data: file, type: "POST", complete: function() {
                setupApp(file);
		var splitInfo = parseDecodedQuery(decodeURIComponent(file));
                $("#dataName").text(splitInfo["project"] + " scraped from " + splitInfo["url"] + " on " + splitInfo["created"] + " from " + splitInfo["from"]);  
                $( "#prevDataSetSelect" ).dialog("close");
            }        });
    }
    
    function setupApp(file) {
        fileName = file;

        editUserOrgsModal();
        
        initializeNetwork();
        
        //Get the available issue types
        $.get("http://localhost:8080/issueTypes", function(data, status, jqXHR) {
            $("#filterContainer #issueTypeFieldset").empty();
            
            $.each(data, function(index, issueType){
                $("#filterContainer #issueTypeFieldset").append("<label for=" + issueType.type + ">" + issueType.type + "</label><input class=\"checkboxradio\" type=\"checkbox\" name=" + issueType.type + " id=" + issueType.type + ">");
            });
            $( "#issueTypeFieldset input.checkboxradio" ).checkboxradio()
                    .change(function(){
                        resetData();
            });
        });
        
        //Get priorities
        $.get("http://localhost:8080/priorities", function(data, status, jqXHR) {
            $("#filterContainer #prioritiesFieldset").empty();
            
            $.each(data, function(index, priority){
                $("#filterContainer #prioritiesFieldset").append("<label for=" + priority.priority + ">" + priority.priority + "</label><input class=\"checkboxradio\" type=\"checkbox\" name=" + priority.priority + " id=" + priority.priority + ">");
            });
            $( "#prioritiesFieldset input.checkboxradio" ).checkboxradio()
                    .change(function(){
                        resetData();
            });
        });

        //Get the relevant date ranges and set up the date filters
        $.get("http://localhost:8080/dates", function(data, status, jqXHR) {
            var creationMinDate = new Date(data[0].creationMin);
            var creationMaxDate = new Date(data[0].creationMax);
            creationMaxDate.setDate(creationMaxDate.getDate() + 1);
            var from = $( "#creationFrom" )
                .datepicker("destroy")
                .datepicker({
                    minDate: creationMinDate,
                    maxDate: creationMaxDate,
                    defaultDate: creationMinDate,
                    changeMonth: true,
                    changeYear: true,
                    dateFormat: dateFormat
                }),
                to = $( "#creationTo" ).datepicker("destroy").datepicker({
                    minDate: creationMinDate,
                    maxDate: creationMaxDate,
                    defaultDate: creationMaxDate,
                    changeMonth: true,
                    changeYear: true,
                    dateFormat: dateFormat
                });

            var resolutionMinDate = new Date(data[0].resolutionMin);
            var resolutionMaxDate = new Date(data[0].resolutionMax);
            resolutionMaxDate.setDate(resolutionMaxDate.getDate() + 1);
            var from = $( "#resolutionFrom" )
                .datepicker("destroy")
                .datepicker({
                    minDate: resolutionMinDate,
                    maxDate: resolutionMaxDate,
                    defaultDate: resolutionMinDate,
                    changeMonth: true,
                    changeYear: true,
                    dateFormat: dateFormat
                }),
                to = $( "#resolutionTo" ).datepicker("destroy").datepicker({
                    minDate: resolutionMinDate,
                    maxDate: resolutionMaxDate,
                    defaultDate: resolutionMaxDate,
                    changeMonth: true,
                    changeYear: true,
                    dateFormat: dateFormat
                });
        });
    };
    
    function setupEventHandlers() {
        $( "#prevDataSetSelect table tbody" ).on("click", "tr td input", function(event, ui) {
            $(event.target).css("display", "none");
            $(event.target).parent().append("<div class=\"loader\"></div>");
        });
        
        $( "#setOrganizations.dialog" ).on("submit", function(event, ui) {
            event.preventDefault();

            $("#setOrganizations .loader").css("display", "");

            var data = {};
            $("#setOrgTable>tbody>tr").each(function() {
                var key = $(this).find("td").first().html();
                var value = $(this).find("input.organization").val();
                if($(this).find("input.ignore:checked").length === 0) {
                    data[key] = value;
                }
            });

            //Update the manually edited user organizations
            $.ajax("http://localhost:8080/usersToOrgs?fileName=" + encodeURIComponent(fileName), {data: data, type: "POST", complete: function() {
                    $("#setOrganizations.dialog").dialog("close");
                    $("#setOrganizations .loader").css("display", "none");
                    resetData();
            }});
        });

        $( "#creationFrom" )
            .on( "change", function() {
                $( "#creationTo" ).datepicker( "option", "minDate", getDate( this ) );
                resetData();
            });

        $( "#creationTo" )
            .on( "change", function() {
                $( "#creationFrom" ).datepicker( "option", "maxDate", getDate( this ) );
                resetData();
            });

        $( "#resolutionFrom" )
            .on( "change", function() {
                $( "#resolutionTo" ).datepicker( "option", "minDate", getDate( this ) );
                resetData();
            });

        $( "#resolutionTo" )
            .on( "change", function() {
                $( "#resolutionFrom" ).datepicker( "option", "maxDate", getDate( this ) );
                resetData();
            });
            
        $( "#notResolved" ).on( "click", resetData);
    }
    
    //Get the users' organizations and redisplay the modal used to manually edit the users' organizations
    function editUserOrgsModal() {
        $("#setOrganizations .loader").css("display", "none");
        $("#setOrganizations tbody tr").remove();
        $.get("http://localhost:8080/users", function(data, status, jqXHR) {
            data.sort(function(a,b) {
                return (b.username.toUpperCase()) < (a.username.toUpperCase()) ? 1 : -1;
            });
            
            $("#setOrgTable>tbody tr").remove();

            $.each(data, function(index, user) {
                $("#setOrgTable>tbody").append("<tr><td>" + user.username + "</td><td>" + user.displayName + "</td><td>" + user.emailAddress + "</td><td><input class=\"organization\" value=\"" + user.organization + "\"/></td><td><input class=\"ignore\" type=\"checkbox\" name=\"Ignore\" value=\"Ignore\" " + (user.ignore  === true || user.ignore === "true" ? "checked" : "") + "></td></tr>");
            });

            $( "#setOrganizations.dialog" ).dialog({
                modal: true,
                width: "700px",
                position: { at: "top" }
            }).css("max-height", ($(window).height() * 0.9) + "px");
        });
    }
    
    function selectJiraSourceModal() {
        $( "#sourceTypeSelection.dialog" ).dialog({
            modal: true
        });
    }
    
    //Get the state of the issue type filters
    function getTypeFilters() {
        var issueTypesString = "";
        $.each($("#filterContainer #issueTypeFieldset input:checked"), function(index, issueTypeCheckbox){
            issueTypesString = issueTypesString + issueTypeCheckbox.id + "+";
        });
        issueTypesString = issueTypesString.slice(0,-1);
        
        return issueTypesString !== "" ? "&issueTypes=" + issueTypesString : issueTypesString;
    }
    
    function getPriorityFilters() {
        var priorityString = "";
        $.each($("#filterContainer #prioritiesFieldset input:checked"), function(index, issueTypeCheckbox){
            priorityString = priorityString + issueTypeCheckbox.id + "+";
        });
        priorityString = priorityString.slice(0,-1);
        
        return priorityString !== "" ? "&priorities=" + priorityString : priorityString;
    }
    
    //Get the state of the date filters
    function getDateFilters() {
        return "&creationFromDate=" + encodeURIComponent($("#creationFrom").val()) + "&creationToDate=" + encodeURIComponent($("#creationTo").val()) + 
               "&resolutionFromDate=" + encodeURIComponent($("#resolutionFrom").val()) + "&resolutionToDate=" + encodeURIComponent($("#resolutionTo").val()) +
               "&unResolved=" + $("#notResolved").is(":checked");
    }
    
    //Get the state of all filters
    function getFilters() {
        var filters = (getTypeFilters() + getPriorityFilters() + getDateFilters()).substring(1);//slice off excess '&'
        return "?" + filters;
    }
    
    //Reset the data being displayed on the graph and table
    var fileSelection;
    var resetNum = 0;
    function resetData() {
        resetNum += 1;
        var thisResetNum = resetNum;
        
        $("#mynetwork .loader").css("display", "");
        
        edges.clear();
        nodes.clear();
        
        var table = document.getElementById("metricsTable");
        while (table.firstChild) {
            table.removeChild(table.firstChild);
        }
        
        var handleAjaxCompletion = function(x) {
            if(thisResetNum !== resetNum) {
                return;
            }
            
            $("#mynetwork .loader").css("display", "none");
            
            if(x.statusText === "error") {
                $("#extraInfoContainer #errorHeader").css("display", "");
            }else {
                $("#extraInfoContainer #errorHeader").css("display", "none");
            }
        };
        
        $.when(
            $.getJSON("http://localhost:8080/" + getFilters(), function(data, status, jqXHR){
                if(thisResetNum !== resetNum) {
                    return;
                }
                
                redrawAll(JSON.parse(jqXHR.responseText));
            }),
            $.getJSON("http://localhost:8080/_metrics" + getFilters(), function(data, status, jqXHR){
                if(thisResetNum !== resetNum) {
                    return;
                }
                
                buildMetricsTable(JSON.parse(jqXHR.responseText));

                var numCol = 0;
                $.each($("#metricsTable tbody tr th"), function(index,column){
                    if ($(column).html() === tableIdColumn) {
                        return false;
                    }else {
                        numCol += 1;
                    }
                });

                if(numCol > 0) {
                    $("#metricsTable tbody tr").each(function() {
                        var tr = $(this);
                        var td1 = tr.find('th:eq(0),td:eq(0)'); // indices are zero-based here
                        var td2 = tr.find('th:eq(' + numCol + '),td:eq(' + numCol + ')');
                        td2.detach().insertBefore(td1);
                    });
                }
            })
        ).then(handleAjaxCompletion, handleAjaxCompletion);
    }

    function initializeNetwork() {
        
        setupDefaultOptions();

        network = new vis.Network(container, data, options);
        
        $(container).prepend("<div class=\"loader center large\" style=\"display:none;\"></div>");

        network.fit();

        network.on('click', handleClick);

        network.on('doubleClick', function(selectionData){
            doubleClickTime = new Date();
            if(selectionData.nodes.length !== 0){
                getHierarchy(selectionData);
            }
        });

        network.on('selectEdge', displayEdgeData);
        
        $("#metricsTable").on("click", function(data){
            var dataJq = $(data.target);
            var node = nodes.get(dataJq.html());
            
            addBackRemovedEdgesAndNodes(node);
            
            if(node !== null){
                removeUnconnectedMembers(node);
            }
            
            resetExtraInfo();
            filterTable(node);
        });
    }
    
    //Display the edge data in place of the table
    function displayEdgeData(selectionData) {
        if(selectionData.nodes.length === 0 && selectionData.edges.length === 1) {
            table = document.getElementById("edgeTable");
            while (table.firstChild) {
                table.removeChild(table.firstChild);
            }

            $("#metricsTable").css("display","none");
            $("#edgeTable").css("display","");            

            var edge = edges.get(selectionData.edges[0]);
            var header = $("#extraInfoContainer h1");
            header.text(edge.from + " > " + edge.to);
            $.getJSON("http://localhost:8080/_edge" + getFilters() + "&org1=" + edge.from + "&org2=" + edge.to, function(data, status, jqXHR){
		buildEdgeTable(JSON.parse(jqXHR.responseText));                
            });
            header.css("display","");
        }
    }
    
    function buildMetricsTable(metricsJSON){
        // EXTRACT VALUE FOR HTML HEADER.
        var col = [];
        for (var i = 0; i < metricsJSON.length; i++) {
            for (var key in metricsJSON[i]) {
                if (col.indexOf(key) === -1 && desiredMetricColumns.indexOf(key) !== -1) {
                    col.push(key);
                }
            }
        }

        // CREATE DYNAMIC TABLE.
        var table = document.getElementById("metricsTable");

        // CREATE HTML TABLE HEADER ROW USING THE EXTRACTED HEADERS ABOVE.

        var tr = table.insertRow(-1);                   // TABLE ROW.

        for (var i = 0; i < col.length; i++) {
            var th = document.createElement("th");      // TABLE HEADER.
            th.innerHTML = col[i];
            tr.appendChild(th);
        }

        // ADD JSON DATA TO THE TABLE AS ROWS.
        for (var i = 0; i < metricsJSON.length; i++) {

            tr = table.insertRow(-1);

            for (var j = 0; j < col.length; j++) {
                var tabCell = tr.insertCell(-1);
                tabCell.innerHTML = metricsJSON[i][col[j]];
            }
        }
    }
    
    function buildEdgeTable(edgeJSON){
        // EXTRACT VALUE FOR HTML HEADER.
        var col = [];
        for (var i = 0; i < edgeJSON.length; i++) {
            for (var key in edgeJSON[i]) {
                if (col.indexOf(key) === -1 && desiredEdgeColumns.indexOf(key) !== -1) {
                    col.push(key);
                }
            }
        }
        // CREATE DYNAMIC TABLE.
        var table = document.getElementById("edgeTable");
        // CREATE HTML TABLE HEADER ROW USING THE EXTRACTED HEADERS ABOVE.
        var tr = table.insertRow(-1);                   // TABLE ROW.
        for (var i = 0; i < col.length; i++) {
            var th = document.createElement("th");      // TABLE HEADER.
            th.innerHTML = col[i];
            tr.appendChild(th);
        }
        // ADD JSON DATA TO THE TABLE AS ROWS.
        for (var i = 0; i < edgeJSON.length; i++) {
            tr = table.insertRow(-1);
            for (var j = 0; j < col.length; j++) {
                var tabCell = tr.insertCell(-1);
                tabCell.innerHTML = edgeJSON[i][col[j]];
            }
        }
    }

    //Re-add removed nodes and edges to the graph
    var removedEdges = [];
    var removedNodes = [];
    function redrawAll(parsedJson) {
        /*if (gephiJSON.nodes === undefined) {
            gephiJSON = gephiImported;
        }
        else {
            gephiImported = gephiJSON;
        }*/

        nodes.clear();
        edges.clear();
        removedEdges = [];
        removedNodes = [];

        //var parsed = vis.network.gephiParser.parseGephi(gephiJSON); 

        var tmpNodeIds = new Set();
        parsedJson.forEach(function(e){
            e.label = e.label.toString().substr(0,4);
            
            tmpNodeIds.add(e.from);
            tmpNodeIds.add(e.to);
        });
        
        var tmpNodes = [];
        tmpNodeIds.forEach(function(id){
            tmpNodes.push({
                id : id,
                label : id
            });
        });
        
        // add the parsed data to the DataSets
        nodes.add(tmpNodes);
        edges.add(parsedJson);
    }
 
    //Filter the graph
    function removeUnconnectedMembers(mainNode){
        var safeNodes = new Set([]);
        var edgeArray = edges.get();
        for(i = 0; i < edgeArray.length; i++){
            var edge = edgeArray[i];
            if(mainNode.id !== edge.from && mainNode.id !== edge.to){
                edges.remove(edge.id);
                removedEdges.push(edge);
            }else{
                safeNodes.add(edge.from);
                safeNodes.add(edge.to);
            }
        }
        var nodeArray = nodes.get();
        for(i = 0; i < nodeArray.length; i++){
            if(!safeNodes.has(nodeArray[i].id)){
                nodes.remove(nodeArray[i].id);
                removedNodes.push(nodeArray[i]);
            }
        }
    }
    
    //Add back connected removed nodes and edges for the given node
    function addBackRemovedEdgesAndNodes(forNode){
        if(forNode === null || forNode === undefined) {
            edges.add(removedEdges);
            removedEdges = [];
        }else {
            var stillRemovedEdges = [];
            for(i = 0; i < removedEdges.length; i++){
                if(removedEdges[i].from === forNode.id || removedEdges[i].to === forNode.id){
                    edges.add(removedEdges[i]);
                }else {
                    stillRemovedEdges.push(removedEdges[i]);
                }
            }
            removedEdges = stillRemovedEdges;
        }
        
        nodes.add(removedNodes);
        removedNodes = [];
    }
    
    //Click handling on graph to make sure double clicks are not interpreted as two single clicks
    function handleClick(selectionData){
        var t0 = new Date();
        if (t0 - doubleClickTime > threshold) {
            setTimeout(function () {
                if (t0 - doubleClickTime > threshold) {
                    doClick(selectionData);
                }
            },threshold);
        }
    }
    
    //click handling on graph
    function doClick(selectionData) {
        if(!(selectionData.edges.length === 1 && selectionData.nodes.length === 0 && options.layout.hierarchical.enabled)){
            setupDefaultOptions();
            network.setOptions(options);
        }
        if(selectionData.nodes.length === 0 && selectionData.edges.length === 0){
            addBackRemovedEdgesAndNodes();
            resetExtraInfo();
            filterTable(null);
        }else if(selectionData.nodes.length !== 0){
            var selectedNode = nodes.get(selectionData.nodes[0]);
            addBackRemovedEdgesAndNodes(selectedNode);
            removeUnconnectedMembers(selectedNode);
            resetExtraInfo();
            filterTable(selectedNode);
        }
    }
    
    //Filter the data in the table, dependant on selected node
    function filterTable(selectedNode){
        var rows = $("#metricsTable > tbody > tr:not(:first-child)");
        rows.css("display", "");
        rows.css("font-weight", "");
        
        var orgTds = rows.children("td:first-child");
        
        $.each(orgTds, function(index, orgTd) {
            var nodeArray = nodes.get();
            var orgTdJq = $(orgTd);
            var safe = false;
            for(i = 0; i < nodeArray.length; i++){
                if(nodeArray[i].id === orgTdJq.html()){
                    safe = true;
                    break;
                }
            }
            if(!safe){
                orgTdJq.parent().css("display", "none");
            }else if(selectedNode !== null && orgTdJq.html() === selectedNode.id){
                orgTdJq.parent().css("font-weight", "bold");
            }
        });
    }
    
    function getDate( element ) {
        var date;
        try {
          date = $.datepicker.parseDate( dateFormat, element.value );
        } catch( error ) {
          date = null;
        }

        return date;
    }
    
    //Go back to showing the table instead of the extra edge info
    function resetExtraInfo(){
        $("#extraInfoContainer h1").css("display","none");
        $("#metricsTable").css("display","");
        $("#edgeTable").css("display","none");
    }
    
    //Change to a hierarchal graph structure with the selected node being the top node
    function getHierarchy(selectionData){
        var mainNode = nodes.get(selectionData.nodes[0]);
        for(e in network.body.edges){
            var edge = edges.get(e);
            if(edge !== null && mainNode.id !== edge.from){
                edges.remove(e);
                removedEdges.push(edge);
            }
        }
        var hierarchOptions = options;
        hierarchOptions.layout = {
          hierarchical: {
            enabled: true,
            sortMethod: 'directed'
          }
        };
        hierarchOptions.edges.font.align = 'horizontal';
        
        network.setOptions(hierarchOptions);
    }
    
    //Set the vis.js default options
    function setupDefaultOptions(){
        options = {
            nodes: {borderWidth: 0, font: { color: '#FFF', size: 27 }},
            edges: {arrows: {to: {enabled: true}}, font: {size: 20, align: 'top'}},
            interaction: {hideEdgesOnDrag: true},
            physics: {
                forceAtlas2Based: {
                  gravitationalConstant: -36,
                  springLength: 150,
                  damping: 0.46,
                  avoidOverlap: 0.04
                },
                maxVelocity: 29,
                minVelocity: 1.45,
                solver: "forceAtlas2Based"
              },
            layout: {hierarchical: {enabled: false}}
        };
    }
    
    function parseDecodedQuery(qstr) {
        var query = {};
        var a = (qstr[0] === '?' ? qstr.substr(1) : qstr).split('&');
        for (var i = 0; i < a.length; i++) {
            var b = a[i].split('=');
            query[b[0]] = b[1];
        }
        return query;
    }
</script>
</body>
</html>
